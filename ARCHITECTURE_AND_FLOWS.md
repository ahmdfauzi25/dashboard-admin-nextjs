# Game Top Up Authentication - System Architecture & Flow

## ğŸ“ High-Level Architecture

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        CLIENT BROWSER                        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  /auth/register    /auth/verify-otp    /auth/login          â”‚
â”‚  /dashboard/otp-management (Admin Only)                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
                    HTTP/HTTPS (REST API)
                             â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      NEXT.JS 14 SERVER                         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  â”Œâ”€ API Routes (Next.js App Router)                             â”‚
â”‚  â”‚  â”œâ”€ /api/auth/register      â†’ generateOTP + sendEmail/SMS   â”‚
â”‚  â”‚  â”œâ”€ /api/auth/verify-otp    â†’ validateOTP + markVerified    â”‚
â”‚  â”‚  â”œâ”€ /api/auth/login         â†’ validatePassword + generateJWTâ”‚
â”‚  â”‚  â”œâ”€ /api/auth/logout        â†’ clearCookie                  â”‚
â”‚  â”‚  â””â”€ /api/admin/**           â†’ requireRole('admin')          â”‚
â”‚  â”‚                                                              â”‚
â”‚  â”œâ”€ Middleware (auth-middleware.js)                            â”‚
â”‚  â”‚  â”œâ”€ dashboardAuthMiddleware â†’ Check role !== 'customer'    â”‚
â”‚  â”‚  â”œâ”€ apiAuthMiddleware       â†’ Check JWT token valid        â”‚
â”‚  â”‚  â””â”€ logoutMiddleware        â†’ Clear auth cookie            â”‚
â”‚  â”‚                                                              â”‚
â”‚  â””â”€ Frontend Pages (React 18 Components)                       â”‚
â”‚     â”œâ”€ /auth/register          (Registration form)             â”‚
â”‚     â”œâ”€ /auth/verify-otp        (OTP verification)              â”‚
â”‚     â”œâ”€ /auth/login             (Login form)                    â”‚
â”‚     â””â”€ /dashboard/otp-management (Admin dashboard)             â”‚
â”‚                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚                          â”‚
    JWT Validation            Data Persistence
    bcrypt Hashing            & Audit Trail
         â”‚                          â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      MYSQL DATABASE                             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  â”Œâ”€ Core Tables                                                 â”‚
â”‚  â”‚  â”œâ”€ users              (id, email, phone, password_hash...  â”‚
â”‚  â”‚  â”œâ”€ otps               (user_id, otp_code, expires_at...)   â”‚
â”‚  â”‚  â”‚                                                            â”‚
â”‚  â”œâ”€ Audit & Security                                            â”‚
â”‚  â”‚  â”œâ”€ login_history      (user_id, ip, status, timestamp...)  â”‚
â”‚  â”‚  â”œâ”€ otp_logs           (user_id, channel, status...)        â”‚
â”‚  â”‚  â”œâ”€ blacklist          (type, value, expires_at...)         â”‚
â”‚  â”‚  â”‚                                                            â”‚
â”‚  â””â”€ Configuration                                               â”‚
â”‚     â””â”€ otp_templates      (channel, template_text...)          â”‚
â”‚                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
    External Services:
    Email (Nodemailer)
    WhatsApp (Twilio)
```

---

## ğŸ”„ User Registration Flow

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   USER CLICKS REGISTER                       â”‚
â”‚                                                              â”‚
â”‚  Fills: Name, Email, Phone (WhatsApp), Password             â”‚
â”‚         Confirm Password                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚
                         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚            CLIENT-SIDE VALIDATION (React)                   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  âœ“ All fields filled                                        â”‚
â”‚  âœ“ Password â‰¥ 8 characters                                  â”‚
â”‚  âœ“ Passwords match                                          â”‚
â”‚  âœ“ Email format valid                                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚
                         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         POST /api/auth/register (Server-Side)               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Step 1: Input Validation (repeat server-side)              â”‚
â”‚          â”œâ”€ Check all fields present                        â”‚
â”‚          â”œâ”€ Check password length                           â”‚
â”‚          â””â”€ Check email format valid                        â”‚
â”‚                                                              â”‚
â”‚  Step 2: Security Checks                                    â”‚
â”‚          â”œâ”€ Is email in BLACKLIST? â†’ Reject (403)           â”‚
â”‚          â”œâ”€ Is phone in BLACKLIST? â†’ Reject (403)           â”‚
â”‚          â””â”€ Does email already exist? â†’ Reject (409)        â”‚
â”‚                                                              â”‚
â”‚  Step 3: Create User                                        â”‚
â”‚          â”œâ”€ Hash password with bcrypt (10 rounds)           â”‚
â”‚          â”‚  Input:  "SecurePass123"                         â”‚
â”‚          â”‚  Output: "$2b$10$JJDmewrxH6CG..."                â”‚
â”‚          â”‚                                                   â”‚
â”‚          â””â”€ INSERT INTO users (                              â”‚
â”‚               name, email, phone,                            â”‚
â”‚               password_hash,                                â”‚
â”‚               role='customer',         â† IMPORTANT          â”‚
â”‚               is_verified=FALSE,       â† Not verified yet   â”‚
â”‚               is_active=TRUE,                                â”‚
â”‚               created_at=NOW()                               â”‚
â”‚             )                                                â”‚
â”‚                                                              â”‚
â”‚  Step 4: Generate OTP                                       â”‚
â”‚          â””â”€ otp_code = random 6 digits (000000-999999)      â”‚
â”‚                                                              â”‚
â”‚  Step 5: Create OTP Records                                 â”‚
â”‚          â”œâ”€ INSERT INTO otps (                               â”‚
â”‚          â”‚   user_id=X,                                      â”‚
â”‚          â”‚   otp_code='123456',                              â”‚
â”‚          â”‚   channel='email',                                â”‚
â”‚          â”‚   is_used=FALSE,                                  â”‚
â”‚          â”‚   expires_at=NOW() + 10min,                      â”‚
â”‚          â”‚   attempts=0,                                     â”‚
â”‚          â”‚   max_attempts=3                                  â”‚
â”‚          â”‚ )                                                 â”‚
â”‚          â”‚                                                   â”‚
â”‚          â””â”€ INSERT INTO otps (same with channel='whatsapp')  â”‚
â”‚                                                              â”‚
â”‚  Step 6: Send OTP via Email                                 â”‚
â”‚          â”œâ”€ Get template from otp_templates (channel='email')
â”‚          â”œâ”€ Replace {{OTP_CODE}} with actual code           â”‚
â”‚          â”œâ”€ Send via Nodemailer                             â”‚
â”‚          â”œâ”€ Log in otp_logs with status='sent'              â”‚
â”‚          â””â”€ Return: email_sent=true/false                   â”‚
â”‚                                                              â”‚
â”‚  Step 7: Send OTP via WhatsApp                              â”‚
â”‚          â”œâ”€ Get template from otp_templates (channel='whatsapp')
â”‚          â”œâ”€ Replace {{OTP_CODE}} with actual code           â”‚
â”‚          â”œâ”€ Send via Twilio/WhatsApp API                    â”‚
â”‚          â”œâ”€ Log in otp_logs with status='sent'              â”‚
â”‚          â””â”€ Return: whatsapp_sent=true/false                â”‚
â”‚                                                              â”‚
â”‚  Step 8: Return Response                                    â”‚
â”‚          {                                                   â”‚
â”‚            "success": true,                                  â”‚
â”‚            "user_id": 42,                                    â”‚
â”‚            "email_sent": true,                               â”‚
â”‚            "whatsapp_sent": true                             â”‚
â”‚          }                                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚
                         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚     REGISTRATION SUCCESS - Redirect to OTP Verification      â”‚
â”‚                                                              â”‚
â”‚     /auth/verify-otp?user_id=42                             â”‚
â”‚                                                              â”‚
â”‚     (User now checks email & WhatsApp for OTP code)         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## âœ… OTP Verification Flow

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚           USER ON /auth/verify-otp PAGE                     â”‚
â”‚                                                              â”‚
â”‚  Sees 6-digit input field                                   â”‚
â”‚  Copy OTP from email or WhatsApp                            â”‚
â”‚  Paste into input field                                     â”‚
â”‚  Click "Verify OTP"                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚
                         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚        POST /api/auth/verify-otp (Server-Side)              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Request: { user_id: 42, otp_code: "123456" }              â”‚
â”‚                                                              â”‚
â”‚  Step 1: Validate Input                                     â”‚
â”‚          â”œâ”€ user_id provided? â†’ Yes                         â”‚
â”‚          â”œâ”€ otp_code provided? â†’ Yes                        â”‚
â”‚          â””â”€ otp_code is 6 digits? â†’ Yes                     â”‚
â”‚                                                              â”‚
â”‚  Step 2: Check User Exists                                  â”‚
â”‚          â””â”€ SELECT * FROM users WHERE id=42                 â”‚
â”‚             â”œâ”€ Found: user_id=42, email="test@ex.com"       â”‚
â”‚             â”œâ”€ is_verified=FALSE (good, not yet verified)   â”‚
â”‚             â””â”€ Continue...                                   â”‚
â”‚                                                              â”‚
â”‚  Step 3: Check Already Verified                             â”‚
â”‚          â””â”€ Is user.is_verified=TRUE? â†’ No (good)           â”‚
â”‚                                                              â”‚
â”‚  Step 4: Find OTP Record                                    â”‚
â”‚          â””â”€ SELECT * FROM otps WHERE                         â”‚
â”‚              user_id=42 AND                                  â”‚
â”‚              otp_code='123456' AND                           â”‚
â”‚              is_used=FALSE AND                               â”‚
â”‚              is_expired=FALSE                                â”‚
â”‚             â”œâ”€ Found: otp_id=999                            â”‚
â”‚             â”œâ”€ attempts=0 (new)                             â”‚
â”‚             â”œâ”€ max_attempts=3                                â”‚
â”‚             â””â”€ Continue...                                   â”‚
â”‚                                                              â”‚
â”‚  Step 5: Check Expiration                                   â”‚
â”‚          â”œâ”€ Expired_at = 2024-01-15 14:35:00                â”‚
â”‚          â”œâ”€ Now = 2024-01-15 14:28:00                       â”‚
â”‚          â”œâ”€ Difference = 7 minutes (within 10 min window)   â”‚
â”‚          â””â”€ Valid! Continue...                               â”‚
â”‚                                                              â”‚
â”‚  Step 6: Check Max Attempts                                 â”‚
â”‚          â”œâ”€ attempts=0, max_attempts=3                       â”‚
â”‚          â”œâ”€ 0 < 3? â†’ Yes                                    â”‚
â”‚          â””â”€ Continue...                                      â”‚
â”‚                                                              â”‚
â”‚  âœ“ ALL CHECKS PASS! OTP IS VALID                            â”‚
â”‚                                                              â”‚
â”‚  Step 7: Mark OTP as Used                                   â”‚
â”‚          â””â”€ UPDATE otps SET                                  â”‚
â”‚              is_used=TRUE,                                  â”‚
â”‚              verified_at=NOW()                              â”‚
â”‚              WHERE id=999                                   â”‚
â”‚                                                              â”‚
â”‚  Step 8: Mark User as Verified                              â”‚
â”‚          â””â”€ UPDATE users SET                                â”‚
â”‚              is_verified=TRUE                               â”‚
â”‚              WHERE id=42                                    â”‚
â”‚                                                              â”‚
â”‚  Step 9: Log Success in Audit Trail                         â”‚
â”‚          â””â”€ INSERT INTO otp_logs (                           â”‚
â”‚              user_id=42,                                     â”‚
â”‚              otp_code='123456',                              â”‚
â”‚              channel='system',                               â”‚
â”‚              status='verified',                              â”‚
â”‚              created_at=NOW()                                â”‚
â”‚            )                                                 â”‚
â”‚                                                              â”‚
â”‚  Step 10: Return Success Response                           â”‚
â”‚          {                                                   â”‚
â”‚            "success": true,                                  â”‚
â”‚            "message": "Email verification successful",      â”‚
â”‚            "user_id": 42                                     â”‚
â”‚          }                                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚
                         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  DATABASE STATE AFTER VERIFICATION                          â”‚
â”‚                                                              â”‚
â”‚  users table:                                                â”‚
â”‚  â”œâ”€ id=42, email="test@ex.com"                              â”‚
â”‚  â”œâ”€ password_hash="$2b$10$..."                              â”‚
â”‚  â”œâ”€ role="customer"                                         â”‚
â”‚  â””â”€ is_verified=TRUE âœ“ (NOW USER CAN LOGIN)                 â”‚
â”‚                                                              â”‚
â”‚  otps table:                                                 â”‚
â”‚  â”œâ”€ id=999, user_id=42, otp_code="123456"                   â”‚
â”‚  â”œâ”€ is_used=TRUE âœ“ (CANNOT VERIFY AGAIN)                    â”‚
â”‚  â””â”€ verified_at="2024-01-15 14:28:30"                       â”‚
â”‚                                                              â”‚
â”‚  otp_logs table:                                             â”‚
â”‚  â””â”€ [sent email], [sent whatsapp], [verified]               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

                         â”‚
                         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚     OTP VERIFICATION SUCCESS - Redirect to Login             â”‚
â”‚                                                              â”‚
â”‚     /auth/login                                              â”‚
â”‚                                                              â”‚
â”‚     (User can now login with email & password)              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ” Login & Access Control Flow

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚            USER ON /auth/login PAGE                         â”‚
â”‚                                                              â”‚
â”‚  Fills: Email, Password                                     â”‚
â”‚  Clicks "Log In"                                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚
                         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         POST /api/auth/login (Server-Side)                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Request: {                                                  â”‚
â”‚    email: "test@example.com",                                â”‚
â”‚    password: "SecurePass123"                                â”‚
â”‚  }                                                           â”‚
â”‚                                                              â”‚
â”‚  Step 1: Validate Input                                     â”‚
â”‚          â”œâ”€ Email provided? â†’ Yes                           â”‚
â”‚          â”œâ”€ Password provided? â†’ Yes                        â”‚
â”‚          â””â”€ Continue...                                      â”‚
â”‚                                                              â”‚
â”‚  Step 2: Find User                                          â”‚
â”‚          â””â”€ SELECT * FROM users WHERE email="test@ex.com"   â”‚
â”‚             â”œâ”€ Found: id=42, name="Test User"               â”‚
â”‚             â”œâ”€ role="customer"                              â”‚
â”‚             â”œâ”€ is_verified=TRUE âœ“                           â”‚
â”‚             â”œâ”€ is_active=TRUE âœ“                             â”‚
â”‚             â””â”€ Continue...                                   â”‚
â”‚                                                              â”‚
â”‚  Step 3: Check Email Not Blacklisted                        â”‚
â”‚          â””â”€ Is "test@example.com" in blacklist? â†’ No        â”‚
â”‚                                                              â”‚
â”‚  Step 4: Check User Verified                                â”‚
â”‚          â”œâ”€ is_verified=TRUE? â†’ Yes âœ“                       â”‚
â”‚          â”‚  (If FALSE â†’ Return 403: "Verify OTP first")    â”‚
â”‚          â””â”€ Continue...                                      â”‚
â”‚                                                              â”‚
â”‚  Step 5: Check Account Active                               â”‚
â”‚          â”œâ”€ is_active=TRUE? â†’ Yes âœ“                         â”‚
â”‚          â”‚  (If FALSE â†’ Return 403: "Account inactive")    â”‚
â”‚          â””â”€ Continue...                                      â”‚
â”‚                                                              â”‚
â”‚  Step 6: Verify Password                                    â”‚
â”‚          â”œâ”€ Stored Hash: "$2b$10$JJDmewrxH6CG..."           â”‚
â”‚          â”œâ”€ Input Password: "SecurePass123"                 â”‚
â”‚          â”œâ”€ bcrypt.compare() â†’ true âœ“                       â”‚
â”‚          â”‚  (If false â†’ Log failure, Return 401)            â”‚
â”‚          â””â”€ Continue...                                      â”‚
â”‚                                                              â”‚
â”‚  Step 7: Generate JWT Token                                 â”‚
â”‚          â”œâ”€ Payload: {                                      â”‚
â”‚          â”‚   userId: 42,                                    â”‚
â”‚          â”‚   email: "test@example.com",                     â”‚
â”‚          â”‚   name: "Test User",                             â”‚
â”‚          â”‚   role: "customer"  â† CRITICAL FOR ACCESS CONTROL
â”‚          â”‚ }                                                 â”‚
â”‚          â”œâ”€ Secret: (from .env.local)                       â”‚
â”‚          â”œâ”€ Expiry: "24h"                                   â”‚
â”‚          â””â”€ Token: "eyJhbGciOiJIUzI1NiIs..."                â”‚
â”‚                                                              â”‚
â”‚  Step 8: Update Last Login                                  â”‚
â”‚          â””â”€ UPDATE users SET last_login=NOW() WHERE id=42   â”‚
â”‚                                                              â”‚
â”‚  Step 9: Log Login Success                                  â”‚
â”‚          â””â”€ INSERT INTO login_history (                      â”‚
â”‚              user_id=42,                                     â”‚
â”‚              ip_address="192.168.1.1",                       â”‚
â”‚              login_status="success",                         â”‚
â”‚              login_time=NOW()                                â”‚
â”‚            )                                                 â”‚
â”‚                                                              â”‚
â”‚  Step 10: Set HTTP-Only Cookie                              â”‚
â”‚          â”œâ”€ Cookie: auth_token=eyJhbGc...                   â”‚
â”‚          â”œâ”€ httpOnly=true (JavaScript cannot access)        â”‚
â”‚          â”œâ”€ secure=true (HTTPS only)                        â”‚
â”‚          â”œâ”€ sameSite=strict (CSRF protection)               â”‚
â”‚          â””â”€ maxAge=86400 (24 hours)                         â”‚
â”‚                                                              â”‚
â”‚  Step 11: Return Response                                   â”‚
â”‚          {                                                   â”‚
â”‚            "success": true,                                  â”‚
â”‚            "message": "Login successful",                    â”‚
â”‚            "token": "eyJhbGc...",                            â”‚
â”‚            "user": {                                         â”‚
â”‚              "id": 42,                                       â”‚
â”‚              "name": "Test User",                            â”‚
â”‚              "email": "test@example.com",                    â”‚
â”‚              "role": "customer"                              â”‚
â”‚            }                                                 â”‚
â”‚          }                                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚
                         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         CLIENT RECEIVES TOKEN IN COOKIE                      â”‚
â”‚         (Automatically sent with future requests)            â”‚
â”‚                                                              â”‚
â”‚  Browser auto-stores: auth_token=eyJhbGc...                â”‚
â”‚  (Cannot be accessed by JavaScript due to httpOnly flag)   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚
          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
          â”‚                             â”‚
          â–¼                             â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Customer accesses       â”‚  â”‚  Admin accesses          â”‚
â”‚  /customer routes        â”‚  â”‚  /dashboard routes       â”‚
â”‚                          â”‚  â”‚                          â”‚
â”‚  âœ“ Redirects to          â”‚  â”‚  âœ“ Checks middleware:    â”‚
â”‚    /customer page        â”‚  â”‚    - Token valid?        â”‚
â”‚                          â”‚  â”‚    - Role = admin?       â”‚
â”‚  Token includes:         â”‚  â”‚    âœ“ Yes â†’ ALLOWED       â”‚
â”‚  role: "customer"        â”‚  â”‚                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚  Token includes:         â”‚
                               â”‚  role: "admin"          â”‚
                               â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
          â”‚              â”‚              â”‚
          â–¼              â–¼              â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ Customer:    â”‚ â”‚ Admin tries: â”‚ â”‚ No token tries:  â”‚
    â”‚ /dashboard   â”‚ â”‚ /dashboard   â”‚ â”‚ /dashboard       â”‚
    â”‚              â”‚ â”‚              â”‚ â”‚                  â”‚
    â”‚ 403 Forbiddenâ”‚ â”‚ 200 OK âœ“     â”‚ â”‚ Redirect to      â”‚
    â”‚ âœ— BLOCKED    â”‚ â”‚ âœ“ ALLOWED    â”‚ â”‚ /auth/login      â”‚
    â”‚              â”‚ â”‚              â”‚ â”‚                  â”‚
    â”‚ Role check:  â”‚ â”‚ Role check:  â”‚ â”‚ No token check:  â”‚
    â”‚ customer !=  â”‚ â”‚ admin !=     â”‚ â”‚ Returns 401      â”‚
    â”‚ admin âœ—      â”‚ â”‚ customer âœ“   â”‚ â”‚                  â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚              â”‚ â”‚ Middleware:      â”‚
                     â”‚ Admin can:   â”‚ â”‚ Redirect to      â”‚
                     â”‚ - View       â”‚ â”‚ login page       â”‚
                     â”‚   templates  â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚ - View logs  â”‚
                     â”‚ - Manage     â”‚
                     â”‚   blacklist  â”‚
                     â”‚ - Delete     â”‚
                     â”‚   entries    â”‚
                     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ›¡ï¸ Security Layers

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  LAYER 1: CLIENT VALIDATION                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Form validation before sending to server                   â”‚
â”‚  âœ“ Check all fields filled                                  â”‚
â”‚  âœ“ Check password length (8+)                               â”‚
â”‚  âœ“ Instant feedback to user                                 â”‚
â”‚  âœ“ Reduce server load (prevent bad requests)                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚               LAYER 2: INPUT VALIDATION                     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Server-side validation (cannot be bypassed)                â”‚
â”‚  âœ“ Type checking                                            â”‚
â”‚  âœ“ String length validation                                 â”‚
â”‚  âœ“ Regex pattern matching                                   â”‚
â”‚  âœ“ Required field checking                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                 LAYER 3: BLACKLIST CHECK                    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Prevent registration of suspicious entries                 â”‚
â”‚  Query: SELECT * FROM blacklist WHERE                       â”‚
â”‚         type='email' AND value=? AND                        â”‚
â”‚         (expires_at IS NULL OR expires_at > NOW())          â”‚
â”‚  âœ“ Block suspicious emails                                  â”‚
â”‚  âœ“ Block suspicious phone numbers                           â”‚
â”‚  âœ“ Block suspicious IPs                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                LAYER 4: UNIQUENESS CHECK                    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Prevent duplicate accounts                                 â”‚
â”‚  Query: SELECT * FROM users WHERE email=? OR phone=?       â”‚
â”‚  âœ“ Email must be unique                                     â”‚
â”‚  âœ“ Phone must be unique                                     â”‚
â”‚  âœ“ Database constraints enforced                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚             LAYER 5: PASSWORD ENCRYPTION                    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Irreversible password hashing                              â”‚
â”‚  Algorithm: bcrypt with 10 rounds                           â”‚
â”‚  Salt: Automatically generated per password                 â”‚
â”‚  Example:                                                    â”‚
â”‚    Input:  "SecurePass123"                                  â”‚
â”‚    Output: "$2b$10$JJDmewrxH6CG/PxF0QEqnu3Y0V7VcREMH0VWd..."â”‚
â”‚  âœ“ Cannot be reversed                                       â”‚
â”‚  âœ“ Resistant to GPU attacks                                 â”‚
â”‚  âœ“ Resistant to rainbow tables                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                LAYER 6: OTP SECURITY                        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Two-factor authentication before login                     â”‚
â”‚  âœ“ OTP generated: 6 random digits                           â”‚
â”‚  âœ“ OTP expires: 10 minutes                                  â”‚
â”‚  âœ“ OTP attempts limited: 3 max                              â”‚
â”‚  âœ“ OTP channels: Email + WhatsApp                           â”‚
â”‚  âœ“ OTP logged: Complete audit trail                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              LAYER 7: SESSION MANAGEMENT                    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Secure token-based authentication                          â”‚
â”‚  JWT Token:                                                  â”‚
â”‚    âœ“ Payload: {userId, email, role}                         â”‚
â”‚    âœ“ Secret: Random key from environment                    â”‚
â”‚    âœ“ Expiry: 24 hours                                       â”‚
â”‚    âœ“ Signature: HMAC-SHA256                                 â”‚
â”‚  Storage: HTTP-only cookie                                  â”‚
â”‚    âœ“ httpOnly: true (XSS safe)                              â”‚
â”‚    âœ“ secure: true (HTTPS only)                              â”‚
â”‚    âœ“ sameSite: strict (CSRF safe)                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚           LAYER 8: AUTHORIZATION MIDDLEWARE                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Role-based access control at route level                   â”‚
â”‚                                                              â”‚
â”‚  For /dashboard/** routes:                                  â”‚
â”‚    1. Check token exists                                    â”‚
â”‚    2. Verify token signature (JWT)                          â”‚
â”‚    3. Check token not expired                               â”‚
â”‚    4. Extract role from token                               â”‚
â”‚    5. CRITICAL: If role='customer' â†’ 403 FORBIDDEN          â”‚
â”‚    6. If role='admin' or 'moderator' â†’ Allow                â”‚
â”‚                                                              â”‚
â”‚  For API endpoints:                                         â”‚
â”‚    - apiAuthMiddleware(request, ['admin'])                  â”‚
â”‚    - Dynamically check required roles                       â”‚
â”‚    - Return 403 if role not in list                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                 LAYER 9: AUDIT LOGGING                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Complete event tracking for security investigation         â”‚
â”‚                                                              â”‚
â”‚  login_history table:                                        â”‚
â”‚    âœ“ user_id, IP address, user agent                        â”‚
â”‚    âœ“ login status (success/failed/blocked)                  â”‚
â”‚    âœ“ login_time, logout_time                                â”‚
â”‚                                                              â”‚
â”‚  otp_logs table:                                             â”‚
â”‚    âœ“ user_id, otp_code, channel                             â”‚
â”‚    âœ“ status (sent/verified/failed/expired)                  â”‚
â”‚    âœ“ error_message, created_at                              â”‚
â”‚                                                              â”‚
â”‚  Benefits:                                                   â”‚
â”‚    - Detect suspicious patterns                             â”‚
â”‚    - Investigate security incidents                         â”‚
â”‚    - Track user behavior                                    â”‚
â”‚    - Compliance reporting                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              LAYER 10: SQL INJECTION PROTECTION              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Prepared statements (parameterized queries)                â”‚
â”‚                                                              â”‚
â”‚  Safe:     query('SELECT * FROM users WHERE id = ?', [id]) â”‚
â”‚  Unsafe:   query('SELECT * FROM users WHERE id = ' + id)   â”‚
â”‚                                                              â”‚
â”‚  All queries in system use parameterization:                â”‚
â”‚    âœ“ Bind parameters separately                             â”‚
â”‚    âœ“ Prevent SQL injection attacks                          â”‚
â”‚    âœ“ Database escapes values automatically                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ”„ State Transitions

```
USER LIFECYCLE:
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

1. NOT REGISTERED
   â””â”€ Cannot login
   â””â”€ Cannot access any protected routes

2. REGISTERED but NOT VERIFIED
   â””â”€ is_verified = FALSE
   â””â”€ Cannot login (403: "Verify OTP first")
   â””â”€ Must verify OTP to proceed
   â””â”€ OTP available for 10 minutes
   â””â”€ Max 3 verification attempts

3. REGISTERED and VERIFIED
   â””â”€ is_verified = TRUE
   â””â”€ Can login with email + password
   â””â”€ Customer: Access /customer routes
   â””â”€ Admin: Access /dashboard routes

4. LOGGED IN (Customer)
   â””â”€ JWT token in HTTP-only cookie
   â””â”€ role = 'customer'
   â””â”€ Can access /customer/**
   â””â”€ CANNOT access /dashboard/** (403)
   â””â”€ Middleware blocks at route level

5. LOGGED IN (Admin)
   â””â”€ JWT token in HTTP-only cookie
   â””â”€ role = 'admin'
   â””â”€ Can access /dashboard/**
   â””â”€ Can manage OTP, blacklist, etc
   â””â”€ Special privileges enforced

6. LOGGED OUT
   â””â”€ auth_token cookie deleted
   â””â”€ No longer authenticated
   â””â”€ Redirected to /auth/login

ACCOUNT STATUS:
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

ACTIVE (is_active = TRUE)
  â””â”€ Normal operation
  â””â”€ Can login
  â””â”€ Can verify OTP
  â””â”€ Full access based on role

INACTIVE (is_active = FALSE)
  â””â”€ Admin disabled account
  â””â”€ Cannot login (403: "Account inactive")
  â””â”€ Still in database
  â””â”€ Can be reactivated by admin

BLACKLISTED:
  â””â”€ Email, phone, or IP in blacklist table
  â””â”€ Cannot register (403: "Email/Phone blacklisted")
  â””â”€ Admin can add with reason and expiry
  â””â”€ Auto-removed after expiry date
```

---

## ğŸ“Š Response Status Codes

```
2XX SUCCESS:
  200 OK         - Login successful, token issued
  201 Created    - User registered, OTP sent
  
4XX CLIENT ERROR:
  400 Bad Request
    - Missing required fields
    - Invalid email format
    - Password too short
    - Invalid OTP format
    
  401 Unauthorized
    - Invalid credentials
    - Invalid/expired token
    - OTP not matching
    
  403 Forbidden
    - Blacklisted email/phone
    - Customer accessing /dashboard
    - Duplicate user (email/phone exists)
    - Account inactive
    - OTP max attempts exceeded
    - Not verified (is_verified=FALSE)
    
  404 Not Found
    - User not found
    - OTP record not found
    
  409 Conflict
    - User already exists
    
  410 Gone
    - OTP expired (>10 minutes)
    
  429 Too Many Requests
    - Max OTP attempts exceeded (3)

5XX SERVER ERROR:
  500 Internal Server Error
    - Database error
    - Email sending failed
    - Unexpected server error
```

---

This architecture is production-ready and follows industry security best practices! ğŸš€
